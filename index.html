<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Recibos</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <h1>Gestor de Recibos</h1>

    <div id="offlineIndicator"
        style="display: none; background: #ff9800; color: white; padding: 10px; text-align: center; margin-bottom: 10px;">
        Sin conexiÃ³n - Los cambios se guardarÃ¡n localmente
    </div>

    <div id="syncButton"
        style="display: none; background: #4CAF50; color: white; padding: 10px; text-align: center; margin-bottom: 10px; cursor: pointer;">
        <button onclick="window.syncPendingChanges()"
            style="background: white; color: #4CAF50; border: none; padding: 10px 20px; font-size: 16px; cursor: pointer; border-radius: 5px;">
            ðŸ“¤ Push - Subir cambios pendientes al servidor
        </button>
    </div>

    <div class="card">
        <form id="receiptForm">
            <div class="form-group">
                <label>DescripciÃ³n</label>
                <input type="text" id="description" required>
            </div>

            <div class="form-group">
                <label>Fecha</label>
                <input type="date" id="date" required>
            </div>

            <div class="form-group">
                <label>Imagen</label>
                <button type="submit" class="btn-primary">Cargar Recibo</button>
                <div class="upload-area" id="uploadArea">
                    <p>Selecciona una imagen</p>
                    <button type="button" onclick="document.getElementById('fileInput').click()">Subir</button>
                    <button type="button" onclick="document.getElementById('cameraInput').click()">Tomar Foto</button>
                    <textarea id="pasteTextarea" placeholder="Mantene presionado para pegar imagen"
                        style="width: 100%; margin-top: 10px; border: 2px dashed #999; border-radius: 5px; min-height:40px; resize: none;"></textarea>
                    <div id="previewContainer"></div>
                </div>
                <input type="file" id="fileInput" accept="image/*">
                <input type="file" id="cameraInput" accept="image/*" capture="environment">
            </div>


        </form>
    </div>

    <div class="card">
        <h2>Recibos</h2>
        <table>
            <thead>
                <tr>
                    <th>DescripciÃ³n</th>
                    <th>Fecha</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="receiptsBody">
                <tr>
                    <td colspan="3" class="empty-state">Cargando...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="modal" id="imageModal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal()">X</button>
            <h3 id="modalTitle"></h3>
            <p id="modalDate"></p>
            <img id="modalImage" class="modal-image">
        </div>
    </div>

    <script>
        let receipts = {};
        let currentImageData = null;
        let isOnline = navigator.onLine;

        const today = new Date();
        today.setMinutes(today.getMinutes() - today.getTimezoneOffset());
        document.getElementById('date').valueAsDate = today;

        // Cargar recibos desde localStorage
        function loadLocalReceipts() {
            const localReceipts = localStorage.getItem('receipts');
            if (localReceipts) {
                receipts = JSON.parse(localReceipts);
            }
            renderReceipts();
        }

        // Cargar inicial
        loadLocalReceipts();

        // Verificar estado inicial
        if (!isOnline) {
            document.getElementById('offlineIndicator').style.display = 'block';
        }

        // Detectar cambios en conexiÃ³n
        window.addEventListener('online', () => {
            isOnline = true;
            document.getElementById('offlineIndicator').style.display = 'none';
            checkPendingChanges();
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            document.getElementById('offlineIndicator').style.display = 'block';
        });

        function checkPendingChanges() {
            const pending = JSON.parse(localStorage.getItem('pendingReceipts') || '[]');
            const pendingDeletes = JSON.parse(localStorage.getItem('pendingDeletes') || '[]');

            if (pending.length > 0 || pendingDeletes.length > 0) {
                document.getElementById('syncButton').style.display = 'block';
            } else {
                document.getElementById('syncButton').style.display = 'none';
            }
        }

        document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        document.getElementById('cameraInput').addEventListener('change', handleFileSelect);

        const pasteTextarea = document.getElementById('pasteTextarea');

        pasteTextarea.addEventListener('paste', function (event) {
            const items = (event.clipboardData || event.originalEvent?.clipboardData).items;

            for (let item of items) {
                const blob = item.getAsFile();
                if (!blob) continue;

                const reader = new FileReader();
                reader.onload = function (event) {
                    loadImage(event.target.result);
                };
                reader.readAsDataURL(blob);
            }

            event.preventDefault();
        });

        document.addEventListener('paste', function (event) {
            const items = (event.clipboardData || event.originalEvent?.clipboardData).items;

            for (let item of items) {
                if (item.type.indexOf('image') !== -1) {
                    const blob = item.getAsFile();
                    if (!blob) continue;

                    const reader = new FileReader();
                    reader.onload = function (event) {
                        loadImage(event.target.result);
                    };
                    reader.readAsDataURL(blob);
                    event.preventDefault();
                    break;
                }
            }
        });

        function loadImage(dataURL) {
            currentImageData = dataURL;
            document.getElementById('previewContainer').innerHTML =
                `<img src="${currentImageData}" class="preview-image">`;
            pasteTextarea.value = 'âœ“ Imagen cargada';
            setTimeout(() => {
                pasteTextarea.value = '';
            }, 1500);
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    currentImageData = event.target.result;
                    document.getElementById('previewContainer').innerHTML =
                        `<img src="${currentImageData}" class="preview-image">`;
                };
                reader.readAsDataURL(file);
            }
        }

        document.getElementById('receiptForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            if (!currentImageData) {
                alert('Selecciona una imagen');
                return;
            }

            const receiptData = {
                description: document.getElementById('description').value,
                date: document.getElementById('date').value,
                image: currentImageData,
                timestamp: Date.now()
            };

            // Siempre guardar localmente primero
            const localId = 'local_' + Date.now();
            receipts[localId] = receiptData;
            localStorage.setItem('receipts', JSON.stringify(receipts));

            const pending = JSON.parse(localStorage.getItem('pendingReceipts') || '[]');
            pending.push({ id: localId, data: receiptData });
            localStorage.setItem('pendingReceipts', JSON.stringify(pending));

            renderReceipts();
            checkPendingChanges();

            document.getElementById('receiptForm').reset();
            document.getElementById('date').valueAsDate = new Date();
            document.getElementById('previewContainer').innerHTML = '';
            currentImageData = null;

            // Si hay internet, sincronizar automÃ¡ticamente
            if (isOnline) {
                setTimeout(() => window.syncPendingChanges(), 500);
            }
        });

        function renderReceipts() {
            const tbody = document.getElementById('receiptsBody');
            const receiptsArray = Object.entries(receipts).map(([id, data]) => ({
                id,
                ...data
            }));

            receiptsArray.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

            if (receiptsArray.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="empty-state">Sin recibos</td></tr>';
                return;
            }

            tbody.innerHTML = receiptsArray.map(r => `
                <tr>
                    <td>${r.description}${r.id.startsWith('local_') ? ' ðŸ”„' : ''}</td>
                    <td>${new Date(r.date).toLocaleDateString('es')}</td>
                    <td>
                        <button onclick="window.viewReceipt('${r.id}')">Ver</button>
                        <button class="btn-delete" onclick="window.deleteReceipt('${r.id}')">Eliminar</button>
                    </td>
                </tr>
            `).join('');
        }

        window.viewReceipt = function (id) {
            const r = receipts[id];
            if (r) {
                document.getElementById('modalTitle').textContent = r.description;
                document.getElementById('modalDate').textContent = new Date(r.date).toLocaleDateString('es');
                document.getElementById('modalImage').src = r.image;
                document.getElementById('imageModal').classList.add('active');
            }
        };

        window.deleteReceipt = function (id) {
            if (confirm('Â¿Eliminar este recibo?')) {
                delete receipts[id];
                localStorage.setItem('receipts', JSON.stringify(receipts));

                if (!id.startsWith('local_')) {
                    const pendingDeletes = JSON.parse(localStorage.getItem('pendingDeletes') || '[]');
                    pendingDeletes.push(id);
                    localStorage.setItem('pendingDeletes', JSON.stringify(pendingDeletes));
                    checkPendingChanges();
                }

                renderReceipts();
            }
        };

        window.syncPendingChanges = async function () {
            if (!isOnline) {
                alert('No hay conexiÃ³n a internet');
                return;
            }

            const pending = JSON.parse(localStorage.getItem('pendingReceipts') || '[]');
            const pendingDeletes = JSON.parse(localStorage.getItem('pendingDeletes') || '[]');

            if (pending.length === 0 && pendingDeletes.length === 0) {
                document.getElementById('syncButton').style.display = 'none';
                return;
            }

            try {
                const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js");
                const { getDatabase, ref, set, remove, push } = await import("https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js");

                const firebaseConfig = {
                    apiKey: "AIzaSyASah_0fZEcxkBVC_d1NHQyhTyFlqevlGs",
                    authDomain: "usuarios-94a70.firebaseapp.com",
                    databaseURL: "https://usuarios-94a70-default-rtdb.firebaseio.com",
                    projectId: "usuarios-94a70",
                    storageBucket: "usuarios-94a70.firebasestorage.app",
                    messagingSenderId: "1080132028374",
                    appId: "1:1080132028374:web:972f95d26fe2108e530677"
                };

                const app = initializeApp(firebaseConfig);
                const database = getDatabase(app);
                const receiptsRef = ref(database, 'receipts');

                // Subir nuevos recibos
                for (const item of pending) {
                    const newReceiptRef = push(receiptsRef);
                    await set(newReceiptRef, item.data);
                    delete receipts[item.id];
                }

                // Eliminar recibos pendientes
                for (const id of pendingDeletes) {
                    await remove(ref(database, `receipts/${id}`));
                }

                localStorage.removeItem('pendingReceipts');
                localStorage.removeItem('pendingDeletes');
                localStorage.setItem('receipts', JSON.stringify(receipts));

                document.getElementById('syncButton').style.display = 'none';

                // Recargar datos de Firebase
                const { onValue } = await import("https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js");
                onValue(receiptsRef, (snapshot) => {
                    receipts = snapshot.val() || {};
                    localStorage.setItem('receipts', JSON.stringify(receipts));
                    renderReceipts();
                }, { onlyOnce: true });

                alert('Cambios sincronizados correctamente');
            } catch (error) {
                console.error('Error al sincronizar:', error);
                alert('Error al sincronizar. Verifica tu conexiÃ³n.');
            }
        };

        window.closeModal = function () {
            document.getElementById('imageModal').classList.remove('active');
        };

        document.getElementById('imageModal').addEventListener('click', function (e) {
            if (e.target === this) window.closeModal();
        });

        // Verificar cambios pendientes al cargar
        checkPendingChanges();
    </script>
</body>

</html>
